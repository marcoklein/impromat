FROM node:18-alpine

# Dokku requires bash
RUN apk add --no-cache bash

WORKDIR /app
COPY package.json yarn.lock .yarnrc.yml ./
COPY .yarn/ .yarn/
COPY packages/impromat-api/package.json /app/packages/impromat-api/package.json
COPY packages/impromat-ai/package.json /app/packages/impromat-ai/package.json
COPY . .
RUN yarn workspaces focus impromat-api
RUN yarn workspaces focus impromat-ai

WORKDIR /app/packages/impromat-ai
RUN yarn build

WORKDIR /app/packages/impromat-api
RUN yarn build

HEALTHCHECK --interval=5s --timeout=1s --start-period=5s --retries=10 \
  CMD node healthcheck.js

CMD ["yarn", "start"]
